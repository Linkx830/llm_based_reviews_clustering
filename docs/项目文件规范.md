# 项目文件结构规范（建议 v1.0）

## 1. 顶层目录结构（必须）

```
project-root/
├─ README.md
├─ LICENSE
├─ pyproject.toml              # 或 requirements.txt；依你习惯二选一
├─ .env.example                # 环境变量模板（不包含密钥）
├─ .gitignore
├─ data/
│  ├─ duckdb/
│  │  ├─ amazon.duckdb        # 默认 DuckDB 文件（可改名）
│  │  └─ migrations/           # 可选：建表/变更脚本说明（无代码也可记录SQL文件）
│  ├─ external/                # 外部数据说明（如数据来源、下载方式；不建议提交大文件）
│  └─ samples/                 # 小样本数据（用于快速验证流程，可提交）
├─ configs/
│  ├─ runs/                    # 每次实验运行配置（推荐一run一个yaml）
│  ├─ prompts/                 # Prompt 模板（结构化抽取/洞察/复核等）
│  ├─ schemas/                 # 结构化输出 Schema（JSON Schema / Pydantic定义说明文档）
│  ├─ taxonomy/                # aspect 同义词表、噪声词表等
│  └─ clustering/              # 聚类参数配置说明（KMeans/HDBSCAN等）
├─ docs/
│  ├─ design/                  # 设计文档（含本方案、时序图、评审记录）
│  ├─ data_dictionary.md        # 数据字段说明（reviews/meta）
│  ├─ schema_spec.md            # 附录A：LLM输出Schema规范
│  ├─ table_spec.md             # 附录B：DuckDB表规范与版本字段
│  ├─ file_structure.md         # 本文件结构规范（可放这里）
│  └─ evaluation_protocol.md    # 评估协议（人工标注指南、指标口径）
├─ src/
│  ├─ app/                      # 程序入口/CLI/主控（Orchestrator）
│  ├─ agents/                   # 各Agent实现（职责单一）
│  ├─ tools/                    # LangChain Tools（DuckDBQuery、Embedding、Clustering等）
│  ├─ pipelines/                # 流水线定义（步骤编排、依赖关系）
│  ├─ models/                   # LLM与Embedding的封装（不含密钥）
│  ├─ storage/                  # DuckDB读写抽象、表管理、run_id管理
│  ├─ evaluation/               # 自动评估 + 抽样包生成
│  ├─ visualization/            # 图表生成（趋势/分布/簇可视化）
│  └─ utils/                    # 公共工具（日志、文本处理、版本摘要等）
├─ scripts/
│  ├─ run_pipeline.md           # 如何运行（可用文档代替脚本）
│  ├─ run_baseline.md           # baseline说明
│  └─ export_report.md          # 报告导出说明
├─ outputs/
│  ├─ runs/                     # 每次run的产出目录（按run_id组织）
│  └─ latest -> runs/<run_id>/  # 可选：指向最新一次运行的软链接/说明文件
└─ notebooks/
   ├─ 00_quickstart.ipynb       # 可选：快速浏览与验证（如课程允许）
   ├─ 10_baseline.ipynb
   ├─ 20_llm_extraction.ipynb
   ├─ 30_clustering.ipynb
   └─ 40_report_demo.ipynb
```

---

## 2. 顶层关键文件规范（必须）

### 2.1 `README.md`（必须包含这些段落）

1. 项目一句话简介
2. 数据前提：DuckDB 表 `reviews`、`meta`，通过 `parent_asin` 连接
3. 一条“最短执行路径”（从配置到报告产出）
4. 输出说明：DuckDB中间表 + `outputs/` 中的报告与指标
5. 复现说明：如何指定 `run_id` / `data_slice_id` / 模型与 prompt 版本

### 2.2 `.env.example`（必须）

只放变量名不放值，例如：

* `DUCKDB_PATH=...`
* `LLM_PROVIDER=...`
* `LLM_MODEL=...`
* `API_KEY=...`（空值）
* `RUN_ID=...`（可选）

### 2.3 `pyproject.toml` 或 `requirements.txt`

列出必要依赖的“类型”即可（你最终会填真实依赖），但规范要求：

* 依赖分组：core / dev / optional（如果用pyproject）
* 明确 LangChain 相关依赖属于 core

---

## 3. 配置目录规范（configs/）

### 3.1 `configs/runs/`：一次运行一个配置文件（强制）

命名规范：

* `YYYYMMDD_<topic>_<scope>.yaml`
  例：`20260103_headphones_category.yaml` 或 `20260103_parentasin_B0XXXX.yaml`

该配置文件必须包含：

* 数据切片：`main_category` 或 `parent_asin`、时间窗口、verified/helpful筛选
* 成本控制：候选句过滤阈值、最大LLM调用数（hard limit）
* 模型信息：`llm_provider`、`llm_model`、`embedding_model`
* prompt版本引用：指向 `configs/prompts/` 中的文件名
* 聚类配置引用：指向 `configs/clustering/` 中的配置文件
* run元信息：`run_id`（可自动生成，但要记录）、`pipeline_version`

### 3.2 `configs/prompts/`：Prompt 版本化（强制）

建议子目录：

```
configs/prompts/
├─ extraction/
│  ├─ v1.0.md
│  └─ v1.1.md
├─ judge_recheck/
│  ├─ v1.0.md
├─ insight/
│  ├─ v1.0.md
└─ report/
   ├─ v1.0.md
```

规范要求：

* 每个 prompt 文件顶部必须写：

  * `prompt_version`
  * 输入字段说明（target_sentence/context_text/product_context）
  * 输出 schema 版本引用（指向 `configs/schemas/`）

### 3.3 `configs/schemas/`：结构化输出约束（强制）

建议：

```
configs/schemas/
├─ extraction_schema_v1.json
├─ insight_schema_v1.json
└─ table_contracts.md     # 可选：表与schema对齐说明
```

### 3.4 `configs/taxonomy/`：归一化词表与噪声词表（强制）

```
configs/taxonomy/
├─ aspect_synonyms.csv        # 同义词归一（shipping/delivery等）
├─ noise_terms.csv            # 噪声词（product/item/it/quality...）
└─ aspect_allowlist.csv       # 可选：允许的方面集合（用于约束）
```

### 3.5 `configs/clustering/`：聚类参数配置（强制）

```
configs/clustering/
├─ baseline_kmeans.yaml
├─ hdbscan_semantic.yaml
└─ vectorization.yaml        # TF-IDF/Embedding选择与参数
```

---

## 4. 源码目录规范（src/）

### 4.1 `src/agents/`：每个 Agent 一个文件/模块（强制）

命名规范：`<agent_name>_agent.py`（或同等风格）
建议包含：

* `data_selector_agent`
* `meta_context_agent`
* `preprocess_agent`
* `sentence_builder_agent`
* `opinion_candidate_filter_agent`
* `aspect_sentiment_extractor_agent`
* `extraction_judge_agent`
* `issue_cluster_agent`
* `cluster_insight_agent`
* `report_assembler_agent`
* `evaluation_agent`

规范要求：

* 每个 Agent 必须在模块顶部声明：

  * 责任边界（做什么/不做什么）
  * 输入表/输出表（DuckDB表名）
  * 关键参数来自哪个 config
  * 失败模式与可恢复策略（是否可重试、如何记录）

### 4.2 `src/tools/`：LangChain Tools 封装（强制）

建议至少有：

* DuckDBQueryTool：读写/批处理/事务封装
* StructuredOutputTool：结构化输出解析/校验/重试策略
* EmbeddingTool：向量化服务抽象
* ClusteringTool：聚类执行与簇统计
* LoggingTool：run_log写入、指标快照

### 4.3 `src/pipelines/`：流水线定义（强制）

* 负责定义“执行顺序与依赖”
* 输出 `pipeline_steps` 的稳定顺序（与文档一致）
* 支持：

  * 全流程运行
  * 仅运行某一步（step-level）
  * 断点续跑（检查输出表/版本字段）

### 4.4 `src/storage/`：DuckDB 表契约管理（强制）

* 负责：

  * DuckDB连接管理（单写者策略）
  * 表存在性检查、run_id过滤视图
  * 表契约校验（字段是否齐全）
* 强烈建议这里存放“表名常量”，避免散落在各Agent里。

---

## 5. 输出目录规范（outputs/）

### 5.1 每次运行一个目录（强制）

目录结构：

```
outputs/runs/<run_id>/
├─ run_config.yaml              # 固化本次运行配置（从 configs/runs 拷贝一份）
├─ manifest.json                # 产物清单（包含表名、文件、版本信息）
├─ logs/
│  ├─ orchestrator.log
│  ├─ agent_stats.jsonl         # 每步处理量/失败量/耗时
│  └─ llm_errors.jsonl          # 解析失败/重试记录
├─ reports/
│  ├─ final_report.md
│  └─ executive_summary.md      # 可选
├─ evaluation/
│  ├─ evaluation_metrics.csv
│  ├─ human_eval_pack/
│  │  ├─ samples.csv
│  │  ├─ labeling_guide.md
│  │  └─ labels_template.csv
│  └─ ablation_results.md
└─ figures/
   ├─ rating_distribution.png
   ├─ coverage_funnel.png
   ├─ cluster_size_distribution.png
   └─ top_clusters_trend.png
```

### 5.2 `manifest.json` 内容规范（强制）

必须包含：

* `run_id`, `pipeline_version`, `created_at`
* 数据切片：类目/parent_asin、过滤条件摘要
* 模型：LLM/Embedding/聚类配置ID
* Prompt版本：抽取/洞察/复核各自版本
* 产物列表：生成的报告文件路径、主要图表路径、关键DuckDB表名清单

> 这份 manifest 是“交付验收”的核心证据：别人拿到仓库+duckdb文件就能复现并核对。

---

## 6. 文档目录规范（docs/）

建议必须至少包含以下文件（与你当前方案一致）：

* `docs/data_dictionary.md`：reviews/meta字段说明（你已经有）
* `docs/design/design_v1.1.md`：改进版设计文档（含时序图）
* `docs/schema_spec.md`：附录A（LLM输出schema）
* `docs/table_spec.md`：附录B（DuckDB表规范）
* `docs/evaluation_protocol.md`：人工标注指南、指标口径、消融实验说明
* `docs/file_structure.md`：本文件结构规范

---

## 7. 版本化与命名规范（强制统一）

### 7.1 `run_id` 规范

推荐格式：

* `YYYYMMDD-HHMM_<scope>_<shorttag>`
  例：`20260103-1530_category_headphones_v11`

### 7.2 Prompt 与 Schema 版本

* Prompt：`v1.0`, `v1.1`（文件名即版本）
* Schema：`extraction_schema_v1.json`（schema版本与prompt版本可独立演进）
* 在 `run_config.yaml` 与 `manifest.json` 中必须记录引用关系。

### 7.3 表版本字段

所有落库中间表建议带（至少 run_id/pipeline_version/data_slice_id/created_at），用于在同一 DuckDB 文件中共存多次实验结果。

---

## 8. 安全与隐私规范（建议写进README）

* 不提交含密钥的 `.env`
* 不提交大规模原始数据（`data/duckdb/project.duckdb` 可选择不入库，或只提交 sample）
* 如果 `user_id` 属于敏感信息，报告中避免展示可识别字段（只展示脱敏/聚合）

---

## 9. 最小可行仓库（MVP）要求（10天内建议）

为了保证你10天能交付，最小需要做到：

* `configs/runs/` 至少 1 个可运行配置
* `docs/` 中四份核心文档齐全（设计、schema、表规范、评估协议）
* `outputs/runs/<run_id>/reports/final_report.md` 能生成
* `outputs/runs/<run_id>/evaluation/evaluation_metrics.csv` 能生成
* DuckDB 中间表至少包含：`review_sentences`、`aspect_sentiment_valid`、`issue_clusters`、`cluster_reports`

---

